{% extends "base.html" %}
{% load static %}

{% block title %}Final Test Submissions{% endblock %}

{% block content %}
<div class="container my-5">
  <div class="cozy-dark-glass p-5 rounded-4 shadow-lg">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2 class="text-light mb-0">
        <i class="fa-solid fa-file-lines me-2 text-warning"></i> Final Test Submissions
      </h2>
      <a href="{% url 'academy_manager_dashboard' %}" class="btn btn-outline-light btn-sm">
        <i class="fa-solid fa-arrow-left me-2"></i> Back to Dashboard
      </a>
    </div>

    <p class="text-light mb-4">
      Review submitted final tests and issue certificates for drivers who pass.
    </p>

    <!-- Filter Bar -->
    <div class="row g-3 mb-4">
      <div class="col-md-6">
        <input id="searchInput" type="text"
               class="form-control bg-dark text-light border-secondary"
               placeholder="üîç Filter by user or module..." onkeyup="filterTable()">
      </div>
      <div class="col-md-6">
        <select id="sortFilter" class="form-select bg-dark text-light border-secondary" onchange="sortTable()">
          <option value="">Sort by...</option>
          <option value="user">User</option>
          <option value="module">Module</option>
          <option value="date">Date</option>
        </select>
      </div>
    </div>

    <div class="table-responsive">
      <table id="submissionsTable" class="table table-dark table-striped align-middle mb-0">
        <thead class="table-secondary text-dark">
          <tr>
            <th>User</th>
            <th>Module</th>
            <th>Submitted</th>
            <th>Certificate</th>
            <th>Review</th>
          </tr>
        </thead>
        <tbody>
          {% for s in submissions %}
          <tr>
            <td>{{ s.user }}</td>
            <td>{{ s.module.title }}</td>
            <td>{{ s.submitted_at|date:"d M Y, H:i" }}</td>
            <td>
              {% if s.user.certificate_set.first %}
                <a href="{% url 'academy_generate_certificate_pdf' s.user.certificate_set.first.id %}" 
                   class="btn btn-sm btn-outline-warning">Download PDF</a>
              {% else %}
                <span class="text-warning">Pending Review</span>
              {% endif %}
            </td>
            <td>
              <button class="btn btn-outline-light btn-sm"
                      data-bs-toggle="modal"
                      data-bs-target="#reviewModal-{{ s.id }}">
                Review
              </button>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="5" class="text-center text-light-50 py-3">No submissions yet.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="p-3 mt-4 rounded-3 border border-warning bg-dark bg-opacity-75">
      <p class="mb-1 text-warning fw-bold">
        ‚ö†Ô∏è Only superusers can mark submissions as passed. Certificates are generated automatically.
      </p>
      <p class="mb-0 text-warning">
        Be sure to verify answers before confirming results.
      </p>
    </div>
  </div>
</div>

<!-- ================= Modals ================= -->
{% for s in submissions %}
<div class="modal fade" id="reviewModal-{{ s.id }}" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark text-light rounded-4 border border-secondary">
      <div class="modal-header border-secondary">
        <h5 class="modal-title text-warning">
          <i class="fa-solid fa-file-lines me-2"></i> Final Test Summary ‚Äì {{ s.user }}
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <p><strong>Module:</strong> {{ s.module.title }}</p>
        <p><strong>Submitted:</strong> {{ s.submitted_at|date:"d M Y, H:i" }}</p>
        <hr class="border-secondary">
        <p><strong>Total Questions:</strong> {{ s.total_questions }}</p>
        <p><strong>Correct:</strong> {{ s.correct_count }}</p>
        <p><strong>Incorrect:</strong> {{ s.incorrect_count }}</p>
        <p class="mt-3"><strong>Score:</strong> 
          <span class="text-info fw-bold">{{ s.score_percent }}%</span>
        </p>
      </div>

      <div class="modal-footer border-secondary">
        <form method="post" action="{% url 'academy_manager_mark_pass' s.id %}">
          {% csrf_token %}
          <button type="submit" class="btn btn-success btn-sm">
            <i class="fa-solid fa-award me-2"></i> Mark as Passed
          </button>
        </form>
        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">
          Close
        </button>
      </div>
    </div>
  </div>
</div>
{% endfor %}

<script>
function filterTable() {
  const input = document.getElementById("searchInput").value.toLowerCase();
  const rows = document.querySelectorAll("#submissionsTable tbody tr");

  rows.forEach(row => {
    const user = row.cells[0].innerText.toLowerCase();
    const module = row.cells[1].innerText.toLowerCase();
    row.style.display = user.includes(input) || module.includes(input) ? "" : "none";
  });
}

function sortTable() {
  const select = document.getElementById("sortFilter").value;
  const tbody = document.querySelector("#submissionsTable tbody");
  const rows = Array.from(tbody.querySelectorAll("tr"));

  const getValue = (row, index) => row.cells[index].innerText.toLowerCase();

  let index;
  if (select === "user") index = 0;
  else if (select === "module") index = 1;
  else if (select === "date") index = 2;
  else return;

  rows.sort((a, b) => getValue(a, index).localeCompare(getValue(b, index)));
  tbody.innerHTML = "";
  rows.forEach(r => tbody.appendChild(r));
}
</script>
{% endblock %}
