{% extends "base.html" %}
{% load static %}

{% block title %}Edit Lesson{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="cozy-dark-glass p-5 rounded-4 shadow-lg">

        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="text-light mb-0">
                <i class="fa-solid fa-file-pen me-2 text-warning"></i>
                Edit Lesson Content
            </h2>

            <a href="{% url 'academy_manage_lessons' lesson.module.id %}"
               class="btn btn-outline-light btn-sm">
                <i class="fa-solid fa-arrow-left me-2"></i> Back
            </a>
        </div>

        <form method="POST">
            {% csrf_token %}

            <!-- Title -->
            <div class="mb-3">
                <label class="text-light fw-bold">Lesson Title</label>
                <input type="text"
                       name="title"
                       value="{{ lesson.title }}"
                       class="form-control bg-dark text-light border-secondary">
            </div>

            <!-- Order -->
            <div class="mb-3">
                <label class="text-light fw-bold">Display Order</label>
                <input type="number"
                       name="order"
                       value="{{ lesson.order }}"
                       class="form-control bg-dark text-light border-secondary">
            </div>

            <!-- IMAGE THUMBNAIL PREVIEW -->
            <div class="mb-4">
                <label class="text-light fw-bold">Image URL</label>

                <div class="popover-wrapper d-inline-block"
                     data-bs-toggle="popover"
                     data-bs-trigger="hover focus"
                     data-bs-placement="right"
                     data-bs-html="true"
                     data-bs-content="<img class='popover-thumb' src='{{ lesson.image_url }}'>">

                    <input type="text"
                           name="image_url"
                           id="imageInput"
                           value="{{ lesson.image_url }}"
                           class="form-control bg-dark text-light border-secondary"
                           style="cursor:pointer; max-width:450px;">
                </div>

                <div class="form-text text-light small d-none d-lg-block">
                    Hover to preview the image thumbnail.
                </div>
            </div>

            <!-- VIDEO THUMBNAIL (VIEW PROVIDES video_id) -->
            <div class="mb-4">
                <label class="text-light fw-bold">Video URL</label>

                <div class="popover-wrapper d-inline-block"
                     data-bs-toggle="popover"
                     data-bs-trigger="hover focus"
                     data-bs-placement="right"
                     data-bs-html="true"
                     data-bs-content="
                        {% if video_id %}
                            <img class='popover-thumb' 
                                 src='https://img.youtube.com/vi/{{ video_id }}/mqdefault.jpg'>
                        {% else %}
                            <div class='text-secondary small'>No preview</div>
                        {% endif %}
                     ">

                    <input type="text"
                           name="video_url"
                           value="{{ lesson.video_url }}"
                           class="form-control bg-dark text-light border-secondary"
                           style="cursor:pointer; max-width:450px;">
                </div>

                <div class="form-text text-light small d-none d-lg-block">
                    Hover to preview the video thumbnail.
                </div>
            </div>

            <!-- CONTENT -->
            <div class="mb-4">
                <label class="text-light fw-bold">Lesson Content</label>
                <textarea id="editor"
                          name="content"
                          rows="18"
                          class="form-control"
                          style="background:rgba(0,0,0,0.35); color:white; border:1px solid #888;">{{ lesson.content|safe }}</textarea>
            </div>

            <div class="text-end mt-3">
                <button class="btn btn-success px-4 py-2">
                    <i class="fa-solid fa-floppy-disk me-2"></i> Save Lesson
                </button>
            </div>

        </form>

    </div>
</div>
{% endblock %}

{% block extra_js %}
<style>
.popover-thumb {
    max-width: 140px !important;
    max-height: 140px !important;
    object-fit: cover;
    border-radius: 6px;
}
</style>

<script>
document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll('[data-bs-toggle="popover"]').forEach(el => {
        if (window.innerWidth >= 992) {
            new bootstrap.Popover(el);
        }
    });
});
</script>
{% endblock %}
