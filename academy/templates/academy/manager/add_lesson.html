{% extends "base.html" %}
{% load static %}

{% block title %}Add Lesson{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="cozy-dark-glass p-5 rounded-4 shadow-lg">

        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="text-light mb-0">
                <i class="fa-solid fa-book-open me-2 text-success"></i>
                Add Lesson â€“ {{ module.title }}
            </h2>

            <div class="d-flex gap-2">
                <a href="{% url 'academy_manage_lessons' module.id %}" class="btn btn-outline-light btn-sm">
                    <i class="fa-solid fa-arrow-left me-2"></i> Back
                </a>

                <button form="addLessonForm" class="btn btn-success btn-sm fw-bold px-3">
                    <i class="fa-solid fa-floppy-disk me-1"></i> Save
                </button>
            </div>
        </div>

        <form id="addLessonForm" method="post" class="mx-auto" style="max-width:700px;">
            {% csrf_token %}

            <!-- Title -->
            <div class="mb-3">
                <label class="form-label text-light fw-bold">Lesson Title</label>
                <input type="text" name="title" class="form-control bg-dark text-light border-secondary" required>
            </div>

            <!-- Order -->
            <div class="mb-3">
                <label class="form-label text-light fw-bold">Display Order</label>
                <input type="number" name="order" class="form-control bg-dark text-light border-secondary"
                       value="{{ suggested_order }}" min="1">
            </div>

            <!-- Video URL -->
            <div class="mb-3">
                <label class="form-label text-light fw-bold">Video URL (optional)</label>

                <div class="popover-wrapper d-none d-lg-inline-block w-100"
                     data-bs-toggle="popover"
                     data-bs-trigger="hover"
                     data-bs-placement="right"
                     data-bs-html="true"
                     id="videoPopover"
                     data-bs-content="<div class='popover-thumb-wrapper'>No preview</div>">

                    <input type="url" name="video_url" id="video_input"
                           class="form-control bg-dark text-light border-secondary"
                           placeholder="https://youtube.com/...">
                </div>

                <div class="d-lg-none">
                    <input type="url" name="video_url"
                           class="form-control bg-dark text-light border-secondary"
                           placeholder="https://youtube.com/...">
                </div>

                <div class="form-text text-light small d-none d-lg-block">
                    Hover to preview a thumbnail from YouTube.
                </div>
            </div>

            <!-- Image URL -->
            <div class="mb-4">
                <label class="form-label text-light fw-bold">Image URL (optional)</label>

                <div class="popover-wrapper d-none d-lg-inline-block w-100"
                     data-bs-toggle="popover"
                     data-bs-trigger="hover"
                     data-bs-placement="right"
                     data-bs-html="true"
                     id="imagePopover"
                     data-bs-content="<img class='popover-thumb' src=''>">

                    <input type="url" name="image_url" id="image_input"
                           class="form-control bg-dark text-light border-secondary"
                           placeholder="https://example.com/image.jpg">
                </div>

                <div class="d-lg-none">
                    <input type="url" name="image_url"
                           class="form-control bg-dark text-light border-secondary"
                           placeholder="https://example.com/image.jpg">
                </div>

                <div class="form-text text-light small d-none d-lg-block">
                    Hover to preview a thumbnail.
                </div>
            </div>

            <!-- Content -->
            <div class="mb-4">
                <label class="form-label text-light fw-bold">Lesson Content (optional)</label>
                <textarea name="content" rows="10"
                          class="form-control bg-dark text-light border-secondary"
                          placeholder="Add some intro text here, or leave blank."></textarea>

                <div class="form-text text-light small mt-1">
                    Use HTML for formatting. You can edit properly later.
                </div>
            </div>

            <!-- Submit -->
            <button class="btn btn-success w-100 fw-bold py-2">
                <i class="fa-solid fa-check me-2"></i> Create Lesson
            </button>

        </form>

    </div>
</div>
{% endblock %}

{% block extra_js %}
<style>
.popover-thumb {
    max-width: 120px !important;
    max-height: 120px !important;
    object-fit: cover;
    border-radius: 6px;
}
.popover {
    background: rgba(20,20,20,0.95) !important;
    border: 1px solid #444 !important;
}
</style>

<script>
document.addEventListener("DOMContentLoaded", function () {

    // INIT POPOVERS
    document.querySelectorAll("[data-bs-toggle='popover']").forEach(el => {
        if (window.innerWidth >= 992) new bootstrap.Popover(el);
    });

    const videoInput = document.getElementById("video_input");
    const imageInput = document.getElementById("image_input");
    const videoPopover = document.getElementById("videoPopover");
    const imagePopover = document.getElementById("imagePopover");

    // Extract YouTube ID
    function getYTID(url) {
        const match = url.match(/(?:v=|\.be\/)([^&]+)/);
        return match ? match[1] : null;
    }

    // Update video thumbnail dynamically
    videoInput?.addEventListener("input", function () {
        const id = getYTID(videoInput.value);
        const thumb = id ? `https://img.youtube.com/vi/${id}/mqdefault.jpg` : "";
        videoPopover.setAttribute("data-bs-content",
            thumb
                ? `<img class='popover-thumb' src='${thumb}'>`
                : "No preview"
        );
    });

    // Update image preview dynamically
    imageInput?.addEventListener("input", function () {
        const url = imageInput.value;
        imagePopover.setAttribute("data-bs-content",
            url
                ? `<img class='popover-thumb' src='${url}'>`
                : "No preview"
        );
    });

});
</script>
{% endblock %}
