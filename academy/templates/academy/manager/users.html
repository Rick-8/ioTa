{% extends "base.html" %}
{% load static %}

{% block title %}User Management{% endblock %}

{% block extra_css %}
<style>
  /* Clean readable popover */
  .popover {
    --bs-popover-bg: var(--bs-light);
    --bs-popover-header-bg: var(--bs-light);
    --bs-popover-border-color: var(--bs-secondary);
    --bs-popover-body-color: var(--bs-dark);
    max-width: 260px;
  }

  .popover .btn-danger {
    width: 100%;
  }
</style>
{% endblock %}

{% block content %}
<div class="container my-5">
  <div class="cozy-dark-glass p-4 p-md-5 rounded-4 shadow-lg">

    <!-- HEADER -->
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4">
      <h2 class="text-light mb-3 mb-md-0">
        <i class="fa-solid fa-users-cog me-2 text-warning"></i> Manage Users
      </h2>
      <a href="{% url 'academy_manager_dashboard' %}" class="btn btn-outline-light btn-sm">
        <i class="fa-solid fa-arrow-left me-2"></i> Back
      </a>
    </div>

    <!-- CREATE USER -->
    <h5 class="text-light mb-3">Create New User</h5>
    <form method="POST" class="row g-2 g-md-3 align-items-end mb-5">
      {% csrf_token %}
      <input type="hidden" name="action" value="create">

      <div class="col-12 col-sm-6 col-md-3">
        <label class="form-label text-light small mb-1">Username</label>
        <input type="text" name="username" class="form-control form-control-sm" required>
      </div>

      <div class="col-12 col-sm-6 col-md-3">
        <label class="form-label text-light small mb-1">Email</label>
        <input type="email" name="email" class="form-control form-control-sm">
      </div>

      <div class="col-12 col-sm-6 col-md-3">
        <label class="form-label text-light small mb-1">Password</label>
        <input type="password" name="password" class="form-control form-control-sm" required>
      </div>

      <div class="col-12 col-sm-6 col-md-3">
        <button class="btn btn-success w-100" type="submit">
          <i class="fa-solid fa-user-plus me-2"></i>Create User
        </button>
      </div>
    </form>

    <hr class="border-secondary mb-4">

    <!-- USER LIST -->
    <h5 class="text-light mb-3">Existing Users</h5>

    <div class="table-responsive rounded-3 border border-secondary">
      <table class="table table-dark table-striped align-middle mb-0">
        <thead class="table-secondary text-dark text-center">
          <tr>
            <th>Username</th>
            <th>Email</th>
            <th>Active</th>
            <th>Staff</th>
            <th>Superuser</th>
            <th>Manage</th>
          </tr>
        </thead>

        <tbody class="text-center">
          {% for user in users %}
          <tr>
            <td>{{ user.username }}</td>
            <td>{{ user.email }}</td>
            <td>{{ user.is_active|yesno:"✅,❌" }}</td>
            <td>{{ user.is_staff|yesno:"✅,❌" }}</td>
            <td>{{ user.is_superuser|yesno:"✅,❌" }}</td>

            <td>
              <button class="btn btn-warning btn-sm"
                      data-bs-toggle="offcanvas"
                      data-bs-target="#userOffcanvas-{{ user.id }}">
                <i class="fa-solid fa-cog"></i>
              </button>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="6" class="py-3 text-light-50">No users found.</td>
          </tr>
          {% endfor %}
        </tbody>

      </table>
    </div>

  </div>
</div>


<!-- ========================================================= -->
<!--                     USER OFFCANVAS                        -->
<!-- ========================================================= -->

{% for user in users %}
<div class="offcanvas offcanvas-end bg-dark text-light"
     tabindex="-1"
     id="userOffcanvas-{{ user.id }}"
     style="width: 440px;">

  <div class="offcanvas-header border-bottom border-secondary">
    <h5 class="offcanvas-title">
      <i class="fa-solid fa-user-gear me-2 text-warning"></i>
      Manage {{ user.username }}
    </h5>
    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
  </div>

  <div class="offcanvas-body">

    <!-- UPDATE USER DETAILS -->
    <form method="POST" class="row g-3 mb-4">
      {% csrf_token %}
      <input type="hidden" name="action" value="update">
      <input type="hidden" name="user_id" value="{{ user.id }}">

      <div class="col-12">
        <label class="form-label">Username</label>
        <input type="text" name="username" value="{{ user.username }}" class="form-control" required>
      </div>

      <div class="col-12">
        <label class="form-label">Email</label>
        <input type="email" name="email" value="{{ user.email }}" class="form-control">
      </div>

      <div class="col-12">
        <label class="form-label">New Password (optional)</label>
        <input type="password" name="password" class="form-control">
      </div>

      <div class="col-6">
        <div class="form-check">
          <input class="form-check-input" type="checkbox" name="is_staff" {% if user.is_staff %}checked{% endif %}>
          <label class="form-check-label">Staff</label>
        </div>
      </div>

      <div class="col-6">
        <div class="form-check">
          <input class="form-check-input" type="checkbox" name="is_superuser" {% if user.is_superuser %}checked{% endif %}>
          <label class="form-check-label">Superuser</label>
        </div>
      </div>

      <div class="col-12">
        <button class="btn btn-primary w-100">
          <i class="fa-solid fa-save me-2"></i>Save Changes
        </button>
      </div>
    </form>

    <!-- SUSPEND / ACTIVATE -->
    <form method="POST" class="mb-4">
      {% csrf_token %}
      <input type="hidden" name="action" value="toggle_active">
      <input type="hidden" name="user_id" value="{{ user.id }}">

      {% if user.is_active %}
      <button class="btn btn-warning w-100">
        <i class="fa-solid fa-pause me-2"></i>Suspend User
      </button>
      {% else %}
      <button class="btn btn-success w-100">
        <i class="fa-solid fa-play me-2"></i>Activate User
      </button>
      {% endif %}
    </form>

    <!-- COURSE ASSIGNMENTS -->
    <div class="border border-secondary rounded-3 p-3 mb-4">
      <h6 class="text-warning mb-3">
        <i class="fa-solid fa-book me-2"></i>Course Assignments
      </h6>

      <!-- Assign Course -->
      <form method="POST" class="d-flex gap-2 mb-3">
        {% csrf_token %}
        <input type="hidden" name="action" value="assign_course">
        <input type="hidden" name="user_id" value="{{ user.id }}">

        <select name="course_id" class="form-select bg-dark text-light border-secondary">
          <option value="">Select course…</option>
          {% for c in courses %}
          <option value="{{ c.id }}">{{ c.title }}</option>
          {% endfor %}
        </select>

        <button class="btn btn-outline-success">
          <i class="fa-solid fa-plus"></i>
        </button>
      </form>

      <!-- Assigned Courses -->
      {% with assignments=user.academy_assignments.all %}
      {% if assignments %}
      <ul class="list-group">
        {% for a in assignments %}
        <li class="list-group-item bg-dark text-light border-secondary d-flex justify-content-between align-items-center">
          {{ a.course.title }}

          <form method="POST" class="m-0">
            {% csrf_token %}
            <input type="hidden" name="action" value="unassign_course">
            <input type="hidden" name="assignment_id" value="{{ a.id }}">
            <button class="btn btn-sm btn-outline-danger">
              <i class="fa-solid fa-xmark"></i>
            </button>
          </form>
        </li>
        {% endfor %}
      </ul>
      {% else %}
      <p class="text-secondary small mb-0">No courses assigned.</p>
      {% endif %}
      {% endwith %}
    </div>

    <!-- =============================================== -->
    <!--                  DELETE BUTTON                  -->
    <!-- =============================================== -->

    <!-- Hidden popover template -->
    <template id="delete-confirm-{{ user.id }}">
      <form method="POST" class="text-center m-0">
        {% csrf_token %}
        <input type="hidden" name="action" value="delete">
        <input type="hidden" name="user_id" value="{{ user.id }}">
        <p class="mb-2 text-dark">Are you sure?</p>
        <button type="submit" class="btn btn-danger btn-sm w-100">Delete</button>
      </form>
    </template>

    <!-- Delete button -->
    <button type="button"
            class="btn btn-outline-danger w-100 delete-popover"
            tabindex="0"
            data-popover-template="delete-confirm-{{ user.id }}">
      <i class="fa-solid fa-trash me-2"></i>Delete User
    </button>

  </div>
</div>
{% endfor %}

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", function () {

  document.querySelectorAll(".delete-popover").forEach(btn => {

    let templateId = btn.getAttribute("data-popover-template");
    let template = document.getElementById(templateId);

    new bootstrap.Popover(btn, {
      html: true,
      sanitize: false,
      content: template.innerHTML,
      title: "Confirm Delete",
      placement: "auto",
      trigger: "focus"   // closes when clicking outside
    });

  });

});
</script>
{% endblock %}
